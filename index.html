<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VerticalOps - AI Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    
    <style>
        /* Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Google+Sans:wght@400;500;700&display=swap');

        :root {
            --md-sys-color-surface: #f5f9fc; 
            --md-sys-color-on-surface: #1f1f1f;
            --md-sys-color-primary: #0b57d0;
        }

        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            zoom: 1.02; 
        }

        h1, h2, h3, .google-font { font-family: 'Google Sans', 'Roboto', sans-serif; }

        * { scrollbar-width: none; -ms-overflow-style: none; }
        ::-webkit-scrollbar { display: none; }

        /* Code Block Styling */
        pre { 
            background: #282a2e; 
            border-radius: 12px; 
            padding: 16px; 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-size: 0.85rem; 
            color: #e0e2e5;
            overflow-x: auto;
            border: 1px solid #444746;
            margin-top: 12px;
            margin-bottom: 12px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .code-keyword { color: #cc7832; font-weight: bold; }
        .code-function { color: #ffc66d; } 

        .fade-in { animation: fadeUp 0.4s cubic-bezier(0.2, 0, 0, 1) forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

        .modal-enter { opacity: 0; pointer-events: none; }
        .modal-enter .modal-content { transform: scale(0.95); }
        .modal-active { opacity: 1; pointer-events: auto; }
        .modal-active .modal-content { transform: scale(1); }

        .context-slide-in { animation: slideDown 0.3s ease-out forwards; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .post-card {
            transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
            border: 1px solid #f5f5f5; 
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .post-card:hover {
            box-shadow: 0 12px 24px rgba(0,0,0,0.04), 0 4px 8px rgba(0,0,0,0.02);
            background-color: #ffffff; 
            border-color: #e0e0e0;      
            z-index: 10;
            transform: translateY(-1px);
        }

        .notebook-overlay {
            position: fixed;
            bottom: 0;
            left: 50%;
            width: 95%; 
            max-width: 1100px; 
            height: 85vh; 
            background: white;
            border-top-left-radius: 28px;
            border-top-right-radius: 28px;
            box-shadow: 0 -10px 60px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.02);
            z-index: 100;
            transform: translate(-50%, 110%); 
            transition: transform 0.4s cubic-bezier(0.2, 0, 0, 1);
            display: flex;
            flex-direction: column;
        }
        .notebook-active { transform: translate(-50%, 0); }
        
        .notebook-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(2px);
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .notebook-backdrop.active { opacity: 1; pointer-events: auto; }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #1f1f1f;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 200;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.error { background: #d93025; }

        .ai-processing {
            position: relative;
            overflow: hidden;
        }
        .ai-processing::after {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: translateX(-100%);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        /* Scanning Loader */
        .scanning-loader {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Lightbox Styles */
        .lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
        }
        .lightbox.active { opacity: 1; pointer-events: auto; }
        .lightbox img, .lightbox video {
            max-width: 95%;
            max-height: 95vh;
            border-radius: 4px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .lightbox.active img, .lightbox.active video { transform: scale(1); }
        .lightbox-close {
            position: absolute;
            top: 24px;
            right: 24px;
            color: white;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            padding: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .lightbox-close:hover { background: rgba(255,255,255,0.3); }

        /* Hashtag Highlight */
        .hashtag {
            color: #0b57d0;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
        }
        .hashtag:hover {
            text-decoration: underline;
            color: #003366;
        }

        /* Rich Link Preview Card */
        .link-preview {
            display: block;
            border: 1px solid #e0e2e5;
            border-radius: 16px;
            overflow: hidden;
            margin-top: 16px;
            text-decoration: none;
            transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
            background: #ffffff;
        }
        .link-preview:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
            border-color: #d0d2d5;
            transform: translateY(-1px);
        }
        .link-preview-image {
            width: 100%;
            height: 220px;
            background-color: #f0f4f9;
            background-size: cover;
            background-position: center;
            border-bottom: 1px solid #f0f0f0;
        }
        .link-info {
            padding: 16px;
        }
        .link-domain {
            font-size: 11px;
            text-transform: uppercase;
            color: #5f6368;
            font-weight: bold;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .link-title {
            font-size: 16px;
            font-weight: bold;
            color: #1f1f1f;
            margin-bottom: 6px;
            line-height: 1.4;
            font-family: 'Google Sans', sans-serif;
        }
        .link-desc {
            font-size: 14px;
            color: #444746;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

    </style>
</head>

<body class="h-screen flex overflow-hidden selection:bg-[#c2e7ff] selection:text-[#001d35] p-2 gap-3">

    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <button class="lightbox-close"><i data-lucide="x" class="w-8 h-8"></i></button>
        <div id="lightbox-wrapper" class="w-full h-full flex justify-center items-center"></div>
    </div>

    <div id="toast" class="toast">
        <i id="toast-icon" data-lucide="check-circle-2" class="w-5 h-5 text-[#4caf50]"></i>
        <span id="toast-msg">Action Completed</span>
    </div>

    <div id="compose-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-[#000000]/40 backdrop-blur-[2px] transition-opacity duration-200 modal-enter">
        <div id="compose-modal" class="modal-content bg-white w-full max-w-[600px] rounded-[28px] shadow-xl p-6 transition-all duration-200 ease-out m-4 relative">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 bg-orange-600 text-white rounded-full flex items-center justify-center font-medium text-sm">JD</div>
                    <div>
                        <div class="text-[15px] font-bold text-[#1f1f1f]">Jane Doe</div>
                        <div class="text-xs text-[#444746]">Posting to <span class="font-bold text-[#0b57d0]">Engineering Core</span></div>
                    </div>
                </div>
                <button onclick="closeCompose()" class="p-2 hover:bg-[#f0f4f9] rounded-full text-[#444746] transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <textarea id="compose-text" placeholder="What's on your mind? Paste a link or use #hashtags..." class="w-full min-h-[120px] text-[18px] text-[#1f1f1f] placeholder-[#80868b] border-none outline-none resize-none"></textarea>
                
                <div id="media-preview-container" class="hidden mt-3 relative inline-block">
                    <img id="media-preview-img" src="" class="hidden max-h-48 rounded-xl border border-[#e0e2e5]">
                    <video id="media-preview-video" src="" class="hidden max-h-48 rounded-xl border border-[#e0e2e5]" controls></video>
                    <div id="scan-indicator" class="hidden absolute inset-0 bg-black/40 flex items-center justify-center rounded-xl backdrop-blur-sm z-10">
                        <div class="text-white text-xs font-bold flex flex-col items-center gap-2">
                             <i data-lucide="scan-eye" class="w-6 h-6 animate-pulse"></i>
                             <span>AI Vision Scanning...</span>
                        </div>
                    </div>
                    <button onclick="removeMedia()" class="absolute -top-2 -right-2 bg-black text-white rounded-full p-1 shadow-md hover:bg-gray-800 z-20">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <input type="file" id="media-input" class="hidden" accept="image/*,video/*" onchange="handleFileSelect(event)">

            <div class="flex items-center justify-between pt-2 border-t border-[#f0f0f0]">
                <div class="flex gap-1">
                    <button onclick="document.getElementById('media-input').click()" class="p-2 hover:bg-[#f0f4f9] rounded-full text-[#0b57d0]" title="Add Media">
                        <i data-lucide="image" class="w-5 h-5"></i>
                    </button>
                    <button onclick="insertCodeBlock()" class="p-2 hover:bg-[#f0f4f9] rounded-full text-[#0b57d0]" title="Add Code Block">
                        <i data-lucide="code-2" class="w-5 h-5"></i>
                    </button>
                </div>
                <button id="btn-publish" onclick="publishPost()" class="bg-[#0b57d0] text-white px-6 py-2 rounded-full font-medium text-sm hover:shadow-md hover:bg-[#0b57d0]/90 transition-all flex items-center gap-2">Post</button>
            </div>
        </div>
    </div>

    <div id="notebook-backdrop" class="notebook-backdrop" onclick="closeNotebook()"></div>
    
    <div id="notebook-sheet" class="notebook-overlay overflow-hidden">
        <div class="h-16 border-b border-[#f0f0f0] flex items-center justify-between px-6 shrink-0 bg-white rounded-t-[28px]">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-[#e8f0fe] flex items-center justify-center text-[#0b57d0]">
                    <i data-lucide="notebook-pen" class="w-4 h-4"></i>
                </div>
                <span class="google-font font-bold text-lg text-[#1f1f1f]">Smart Note</span>
            </div>
            
            <div class="flex items-center gap-2">
                <button id="btn-use-ai" onclick="generateAiNotes()" class="px-4 py-2 rounded-full text-sm font-bold text-[#0b57d0] bg-[#e8f0fe] hover:bg-[#d3e3fd] transition-all flex items-center gap-2" title="Generate smart notes">
                    <i data-lucide="bot" class="w-4 h-4"></i> Use AI
                </button>
                <button id="btn-fix-spelling" onclick="fixSpelling()" class="px-4 py-2 rounded-full text-sm font-bold text-[#0b57d0] bg-[#e8f0fe] hover:bg-[#d3e3fd] transition-all flex items-center gap-2 mr-2" title="Fix current text">
                    <i data-lucide="wand-2" class="w-4 h-4"></i> Fix
                </button>
                <div class="h-6 w-px bg-[#e0e2e5]"></div>
                <button onclick="saveNote()" class="px-5 py-2 rounded-full text-sm font-bold bg-[#0b57d0] text-white hover:bg-[#0b57d0]/90 shadow-sm transition-all flex items-center gap-2 ml-2">
                    <i data-lucide="save" class="w-4 h-4"></i> Save
                </button>
                <button onclick="closeNotebook()" class="p-2 rounded-full hover:bg-[#f5f5f5] text-[#444746] transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-0 flex flex-col md:flex-row h-full">
            <div class="w-full md:w-1/3 bg-[#f8f9fa] p-6 border-r border-[#f0f0f0] overflow-y-auto">
                <div class="mb-3 text-xs font-bold text-[#444746] uppercase tracking-wider">Source Content</div>
                <div id="notebook-source-content" class="bg-white p-4 rounded-2xl shadow-sm border border-[#e0e2e5] text-sm text-[#1f1f1f] leading-relaxed"></div>
            </div>
            <div class="w-full md:w-2/3 p-8 flex flex-col bg-white relative">
                <input id="note-title" type="text" placeholder="Note Title..." class="text-2xl font-bold text-[#1f1f1f] placeholder-[#a0a0a0] outline-none border-none w-full mb-4 font-google">
                <textarea id="note-body" placeholder="Type notes here... Or click 'Use AI' to analyze the text, image, or video in the post." class="flex-1 w-full resize-none outline-none border-none text-[16px] text-[#444746] leading-7 font-roboto"></textarea>
            </div>
        </div>
    </div>

    <aside class="w-[280px] flex flex-col shrink-0 p-2 gap-2 pl-4 hidden md:flex">
        <div class="h-16 flex items-center gap-3 pl-2 mb-2">
            <div class="text-[#0b57d0]">
                <i data-lucide="hexagon" class="w-8 h-8 fill-[#0b57d0] stroke-none"></i>
            </div>
            <h1 class="text-[22px] google-font text-[#444746]">Vertical<span class="font-bold text-[#1f1f1f]">Ops</span></h1>
        </div>
        <button onclick="openCompose()" class="w-full h-14 flex items-center gap-4 px-5 bg-[#c2e7ff] text-[#001d35] rounded-[16px] mb-6 shadow-sm hover:shadow-md hover:bg-[#b3dfff] transition-all group">
            <i data-lucide="pencil" class="w-6 h-6"></i>
            <span class="text-[15px] font-medium">Compose</span>
        </button>
        <nav class="space-y-1">
            <a href="#" onclick="clearFilter(); return false;" class="flex items-center gap-5 px-5 py-3.5 bg-[#d3e3fd] text-[#001d35] rounded-full font-semibold transition-colors"><i data-lucide="layout-grid" class="w-5 h-5"></i> Feed</a>
            <a href="#" class="flex items-center gap-5 px-5 py-3.5 text-[#444746] hover:bg-[#e1e3e1] rounded-full font-medium transition-colors"><i data-lucide="hash" class="w-5 h-5"></i> Topics</a>
            <a href="#" class="flex items-center gap-5 px-5 py-3.5 text-[#444746] hover:bg-[#e1e3e1] rounded-full font-medium transition-colors"><i data-lucide="notebook" class="w-5 h-5"></i> Notes</a>
            <a href="#" class="flex items-center gap-5 px-5 py-3.5 text-[#444746] hover:bg-[#e1e3e1] rounded-full font-medium transition-colors"><i data-lucide="user" class="w-5 h-5"></i> Profile</a>
            <a href="#" class="flex items-center gap-5 px-5 py-3.5 text-[#444746] hover:bg-[#e1e3e1] rounded-full font-medium transition-colors"><i data-lucide="settings" class="w-5 h-5"></i> Settings</a>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-white rounded-[24px] relative overflow-hidden shadow-sm border border-[#f0f0f0]">
        <header class="h-20 flex items-center justify-between px-8 shrink-0 z-20 sticky top-0 bg-white/95 backdrop-blur-md border-b border-[#f7f7f7]">
            <div class="flex-1 max-w-[680px] mx-auto relative group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i data-lucide="search" class="w-5 h-5 text-[#444746] group-focus-within:text-[#0b57d0] transition-colors"></i>
                </div>
                <input type="text" placeholder="Search in feed" id="feed-search" onkeyup="filterFeed(this.value)" class="w-full bg-[#f0f4f9] text-[#1f1f1f] border border-transparent rounded-full py-3.5 pl-12 pr-6 text-[16px] hover:bg-[#e9eef6] hover:shadow-sm focus:bg-[#e9eef6] focus:border-[#0b57d0]/30 focus:shadow-md transition-all duration-200 outline-none placeholder-[#444746]/80">
            </div>
            <div class="flex items-center gap-2 pl-4">
                <button class="p-2.5 hover:bg-[#f0f4f9] rounded-full text-[#444746] transition-colors"><i data-lucide="settings-2" class="w-6 h-6"></i></button>
                <button class="p-2.5 hover:bg-[#f0f4f9] rounded-full text-[#444746] transition-colors"><i data-lucide="bell" class="w-6 h-6"></i></button>
                <div class="ml-2 h-10 w-10 bg-orange-600 text-white rounded-full flex items-center justify-center font-medium text-sm border-2 border-white ring-1 ring-[#e0e2e5]">JD</div>
            </div>
        </header>

        <div id="filter-banner" class="hidden bg-[#e8f0fe] px-6 py-3 border-b border-[#c2e7ff] flex items-center justify-between">
            <span class="text-sm font-bold text-[#0b57d0]">Filtered by: <span id="filter-tag"></span></span>
            <button onclick="clearFilter()" class="text-xs text-[#0b57d0] hover:underline font-medium">Clear Filter</button>
        </div>

        <div id="feed-container" class="flex-1 overflow-y-auto p-6 space-y-6 bg-[#ffffff]">
            <article class="post-card rounded-[24px] p-0 group overflow-hidden cursor-default" id="post-1">
                <div class="p-6"> 
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex gap-4">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="w-11 h-11 rounded-full bg-[#f0f4f9]">
                            <div>
                                <h3 class="font-bold text-[#1f1f1f] text-[16px] google-font">Alex Chen</h3>
                                <span class="text-xs text-[#444746] font-medium">Senior Engineer â€¢ 2h</span>
                            </div>
                        </div>
                        <button class="p-2 hover:bg-[#e0e2e5] rounded-full text-[#444746] opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button>
                    </div>
                    <div class="post-content mt-3">
                        <p class="text-[#1f1f1f] text-[16px] leading-7 mb-5">Refactored the authentication middleware. Latency dropped by ~40ms. Code snippet below. ðŸš€ <span class="hashtag" onclick="filterFeed('#Backend')">#Backend</span> <span class="hashtag" onclick="filterFeed('#NodeJS')">#NodeJS</span></p>
                        <div class="bg-[#282a2e] rounded-[18px] overflow-hidden shadow-inner border border-[#444746] mb-2" data-type="code-block" data-lang="javascript">
                            <div class="px-4 py-2.5 bg-[#1f1f1f] border-b border-[#444746] flex gap-2"><div class="w-3 h-3 rounded-full bg-red-500"></div><div class="w-3 h-3 rounded-full bg-yellow-500"></div><div class="w-3 h-3 rounded-full bg-green-500"></div></div>
<pre class="m-0 border-none rounded-none text-sm leading-relaxed"><span class="code-keyword">async function</span> <span class="code-function">verifySession</span>(token) {
  <span class="code-keyword">const</span> cached = <span class="code-keyword">await</span> redis.<span class="code-function">get</span>(token);
  <span class="code-keyword">if</span> (cached) <span class="code-keyword">return</span> JSON.<span class="code-function">parse</span>(cached);
  <span class="code-keyword">return</span> jwt.<span class="code-function">verify</span>(token, SECRET);
}</pre>
                        </div>
                    </div>
                </div>
                <div class="border-t border-[#f5f5f5] w-full"></div> 
                <div class="px-6 py-3 flex items-center justify-between opacity-80 group-hover:opacity-100 transition-opacity">
                    <div class="flex gap-2">
                        <button class="flex items-center gap-2 px-4 py-2.5 rounded-full hover:bg-[#ffebee] hover:text-[#d93025] text-[#444746] text-sm font-bold transition-colors"><i data-lucide="heart" class="w-5 h-5"></i> 24</button>
                        <button class="flex items-center gap-2 px-4 py-2.5 rounded-full hover:bg-[#e8f0fe] hover:text-[#0b57d0] text-[#444746] text-sm font-bold transition-colors"><i data-lucide="message-circle" class="w-5 h-5"></i> 8</button>
                        <button class="p-2.5 rounded-full hover:bg-[#e8f0fe] hover:text-[#0b57d0] text-[#444746] transition-colors" title="Share"><i data-lucide="share-2" class="w-5 h-5"></i></button>
                    </div>
                    <div class="flex gap-2 transform translate-y-2 group-hover:translate-y-0 opacity-0 group-hover:opacity-100 transition-all">
                        <button onclick="pinPost('post-1', 'Alex Chen')" class="flex items-center gap-2 px-4 py-2.5 rounded-full bg-[#e8f0fe] hover:bg-[#d3e3fd] text-[#0b57d0] text-xs font-bold transition-colors"><i data-lucide="sparkles" class="w-4 h-4 fill-[#0b57d0] stroke-none"></i> AI CONTEXT</button>
                        <button onclick="openNotebook('post-1', 'Alex Chen')" class="flex items-center gap-2 px-4 py-2.5 rounded-full bg-[#f0f4f9] hover:bg-[#e0e2e5] text-[#1f1f1f] text-xs font-bold transition-colors"><i data-lucide="notebook-pen" class="w-4 h-4"></i> NOTE</button>
                    </div>
                </div>
            </article>

            <article class="post-card rounded-[24px] p-0 group overflow-hidden cursor-default" id="post-2">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex gap-4">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Sarah" class="w-11 h-11 rounded-full bg-[#f0f4f9]">
                            <div>
                                <h3 class="font-bold text-[#1f1f1f] text-[16px] google-font">Sarah Miller</h3>
                                <span class="text-xs text-[#444746] font-medium">Product Designer â€¢ 4h</span>
                            </div>
                        </div>
                        <button class="p-2 hover:bg-[#e0e2e5] rounded-full text-[#444746] opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button>
                    </div>
                    <div class="post-content mt-3">
                        <p class="text-[#1f1f1f] text-[16px] leading-7 mb-5">New dark mode palette concepts. Testing contrast ratios on mobile viewports. Which one do you prefer? ðŸŽ¨ <span class="hashtag" onclick="filterFeed('#Design')">#Design</span> <span class="hashtag" onclick="filterFeed('#UX')">#UX</span></p>
                        <span class="hidden" data-ai-context>Image Description: A side-by-side comparison of two dark mode UI variants. Variant A is darker, Variant B is lighter.</span>
                        <div class="bg-[#0f172a] rounded-[20px] h-52 flex items-center justify-center relative overflow-hidden border border-[#1e293b] shadow-sm cursor-pointer" onclick="openLightbox('<div class=&quot;grid grid-cols-2 gap-6 w-3/4&quot;><div class=&quot;h-24 bg-[#1e293b] rounded-2xl border border-white/10 shadow-lg flex items-center justify-center text-white/50 text-sm font-medium hover:border-white/40 transition-colors hover:bg-[#273549]&quot;>Variant A</div><div class=&quot;h-24 bg-[#334155] rounded-2xl border border-white/10 shadow-lg flex items-center justify-center text-white/50 text-sm font-medium hover:border-white/40 transition-colors hover:bg-[#405169]&quot;>Variant B</div></div>')">
                             <div class="grid grid-cols-2 gap-6 w-3/4">
                                <div class="h-24 bg-[#1e293b] rounded-2xl border border-white/10 shadow-lg flex items-center justify-center text-white/50 text-sm font-medium hover:border-white/40 transition-colors hover:bg-[#273549]">Variant A</div>
                                <div class="h-24 bg-[#334155] rounded-2xl border border-white/10 shadow-lg flex items-center justify-center text-white/50 text-sm font-medium hover:border-white/40 transition-colors hover:bg-[#405169]">Variant B</div>
                             </div>
                        </div>
                    </div>
                </div>
                <div class="border-t border-[#f5f5f5] w-full"></div>
                <div class="px-6 py-3 flex items-center justify-between opacity-80 group-hover:opacity-100 transition-opacity">
                    <div class="flex gap-2">
                        <button class="flex items-center gap-2 px-4 py-2.5 rounded-full hover:bg-[#ffebee] hover:text-[#d93025] text-[#444746] text-sm font-bold transition-colors"><i data-lucide="heart" class="w-5 h-5"></i> 128</button>
                        <button class="flex items-center gap-2 px-4 py-2.5 rounded-full hover:bg-[#e8f0fe] hover:text-[#0b57d0] text-[#444746] text-sm font-bold transition-colors"><i data-lucide="message-circle" class="w-5 h-5"></i> 42</button>
                        <button class="p-2.5 rounded-full hover:bg-[#e8f0fe] hover:text-[#0b57d0] text-[#444746] transition-colors" title="Share"><i data-lucide="share-2" class="w-5 h-5"></i></button>
                    </div>
                    <div class="flex gap-2 transform translate-y-2 group-hover:translate-y-0 opacity-0 group-hover:opacity-100 transition-all">
                        <button onclick="pinPost('post-2', 'Sarah Miller')" class="flex items-center gap-2 px-4 py-2.5 rounded-full bg-[#e8f0fe] hover:bg-[#d3e3fd] text-[#0b57d0] text-xs font-bold transition-colors"><i data-lucide="sparkles" class="w-4 h-4 fill-[#0b57d0] stroke-none"></i> AI CONTEXT</button>
                        <button onclick="openNotebook('post-2', 'Sarah Miller')" class="flex items-center gap-2 px-4 py-2.5 rounded-full bg-[#f0f4f9] hover:bg-[#e0e2e5] text-[#1f1f1f] text-xs font-bold transition-colors"><i data-lucide="notebook-pen" class="w-4 h-4"></i> NOTE</button>
                    </div>
                </div>
            </article>
        </div>
    </main>

    <aside class="w-[420px] shrink-0 hidden xl:flex flex-col gap-3 h-[calc(100vh-16px)] sticky top-2 pb-6">
        <div class="bg-[#e2e2e2]/50 p-1 rounded-full flex relative shrink-0">
            <button id="btn-mode-ai" onclick="switchMode('ai')" class="flex-1 py-3 rounded-full text-sm font-bold flex items-center justify-center gap-2 transition-all duration-300 shadow-sm bg-white text-[#001d35]">
                <i data-lucide="sparkles" class="w-4 h-4 text-[#0b57d0]"></i> Newton
            </button>
            <button id="btn-mode-trend" onclick="switchMode('trend')" class="flex-1 py-3 rounded-full text-sm font-bold flex items-center justify-center gap-2 transition-all duration-300 text-[#444746] hover:text-[#1f1f1f]">
                <i data-lucide="trending-up" class="w-4 h-4"></i> Trends
            </button>
        </div>
        <div class="flex-1 bg-white rounded-[24px] relative overflow-hidden shadow-sm border border-[#f0f0f0] flex flex-col">
            <div id="view-ai" class="flex flex-col h-full fade-in relative">
                <div class="px-5 py-4 border-b border-[#f7f7f7] bg-white z-10">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                            <span class="text-[16px] google-font font-medium text-[#1f1f1f]">Newton Assistant</span>
                            <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-[#e8f0fe] text-[#0b57d0]">BETA</span>
                        </div>
                        <button class="p-2 hover:bg-[#f0f4f9] rounded-full text-[#444746]" onclick="clearContext()"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                    </div>
                    <div id="ai-context-chip" class="hidden mt-2 bg-[#f0f4f9] border border-[#e0e2e5] rounded-[12px] p-2 flex items-center justify-between context-slide-in">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <i data-lucide="paperclip" class="w-3.5 h-3.5 text-[#0b57d0] shrink-0"></i>
                            <div class="flex flex-col">
                                <span class="text-[10px] text-[#444746] font-bold uppercase tracking-wider">Active Context</span>
                                <span class="text-[12px] text-[#1f1f1f] truncate font-medium" id="ai-context-text">Post by User</span>
                            </div>
                        </div>
                        <button onclick="clearContext()" class="p-1 hover:bg-[#e0e2e5] rounded-full text-[#444746]"><i data-lucide="x" class="w-3 h-3"></i></button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-5 space-y-6" id="chat-history">
                    <div class="flex flex-col gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#d3e3fd] to-[#c2e7ff] flex items-center justify-center shadow-sm">
                            <i data-lucide="sparkles" class="w-5 h-5 text-[#0b57d0]"></i>
                        </div>
                        <div class="text-[15px] text-[#1f1f1f] leading-relaxed bg-[#f0f4f9] p-4 rounded-[20px] rounded-tl-none">
                            <p>Hi! I'm ready to help. Hover over a post and click <span class="font-bold text-[#0b57d0]">AI Context</span> to discuss it. I can now "see" objects and "read" text in your uploaded images!</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-white border-t border-[#f0f0f0]">
                    <div class="relative bg-[#f0f4f9] rounded-[24px] transition-all focus-within:bg-white focus-within:shadow-md border border-transparent focus-within:border-[#e0e0e0]">
                        <input type="text" id="ai-input" placeholder="Ask Newton..." class="w-full pl-5 pr-12 py-4 bg-transparent border-none text-[15px] text-[#1f1f1f] placeholder-[#444746] focus:ring-0 outline-none" autocomplete="off">
                        <button id="ai-send-btn" class="absolute right-2 top-2 p-2 bg-transparent hover:bg-[#d3e3fd] text-[#0b57d0] rounded-full transition-colors"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
                    </div>
                    <div class="flex justify-center mt-3">
                         <span class="text-[9px] font-medium text-[#444746] opacity-50">Newton can make mistakes. Check important info.</span>
                    </div>
                </div>
            </div>
            <div id="view-trend" class="hidden flex-col h-full fade-in bg-white p-6">
                <div class="flex items-center gap-2 mb-6">
                    <i data-lucide="bar-chart-2" class="w-5 h-5 text-[#444746]"></i>
                    <h2 class="text-lg google-font font-medium text-[#1f1f1f]">Internal Trends</h2>
                </div>
                <div class="flex flex-wrap gap-2 mb-8">
                    <span class="px-4 py-2 bg-[#e0f2ff] text-[#001d35] rounded-xl text-xs font-bold border border-[#c2e7ff] cursor-pointer" onclick="filterFeed('#React')">#React</span>
                    <span class="px-4 py-2 bg-[#f0f4f9] text-[#1f1f1f] rounded-xl text-xs font-bold cursor-pointer" onclick="filterFeed('#UX/UI')">#UX/UI</span>
                </div>
            </div>
        </div>
    </aside>

    <script>
        lucide.createIcons();
        let currentContext = "";
        let currentMedia = null;
        let currentMediaType = null;
        let classifier;
        let mediaVisionLog = ""; // To store the analysis result globally during the post process

        // --- INIT ML5 ---
        function setupClassifier() {
            if(typeof ml5 !== 'undefined') {
                console.log("Loading MobileNet...");
                classifier = ml5.imageClassifier('MobileNet', () => { console.log("MobileNet Loaded!"); });
            }
        }
        setupClassifier();

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            const icon = document.getElementById('toast-icon');
            
            toastMsg.innerText = message;
            
            if (isError) {
                toast.classList.add('error');
                icon.setAttribute('data-lucide', 'alert-circle');
                icon.classList.remove('text-[#4caf50]');
                icon.classList.add('text-white');
            } else {
                toast.classList.remove('error');
                icon.setAttribute('data-lucide', 'check-circle-2');
                icon.classList.add('text-[#4caf50]');
                icon.classList.remove('text-white');
            }
            lucide.createIcons();
            
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        // --- CONTENT MODERATION (UPDATED FOR MEDIA) ---
        async function checkContentSafety(text, visionLog) {
            let combinedText = text || "";
            if (visionLog) {
                 combinedText += `\n\n[Vision Log]: ${visionLog}`;
            }

            if (!combinedText.trim()) return true;
            
            const prompt = `You are a content moderation AI. 
            Check the following text and vision logs for:
            1. NSFW/18+ content (sexual, violent, illegal).
            2. "Brainrot" or "Gen Alpha" slang used excessively or nonsensically (e.g., skibidi, gyatt, rizz, sigma, fanum tax, ohio).
            3. Explicit mention of "AI generated video" or "deepfake" in the vision log or text.
            
            If the content contains ANY of these, reply exactly "BLOCK".
            Otherwise, reply "SAFE".
            
            Content: "${combinedText}"`;
            
            try {
                const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}?model=openai`);
                const result = await response.text();
                return result.trim().toUpperCase().includes("SAFE");
            } catch (e) { 
                console.error("Content Safety Check Failed:", e);
                return true; // Fail open for demo stability
            } 
        }

        // --- FILTER LOGIC ---
        function filterFeed(tag) {
            const posts = document.querySelectorAll('.post-card');
            const banner = document.getElementById('filter-banner');
            const filterTag = document.getElementById('filter-tag');
            const searchTerm = tag.toLowerCase().trim();
            if(!searchTerm) { clearFilter(); return; }
            banner.classList.remove('hidden');
            filterTag.innerText = tag;
            posts.forEach(post => {
                if(post.innerText.toLowerCase().includes(searchTerm)) post.classList.remove('hidden');
                else post.classList.add('hidden');
            });
        }

        function clearFilter() {
            const posts = document.querySelectorAll('.post-card');
            posts.forEach(p => p.classList.remove('hidden'));
            document.getElementById('filter-banner').classList.add('hidden');
            document.getElementById('feed-search').value = "";
        }

        // --- TOGGLE TEXT ---
        function toggleText(id) {
            const shortView = document.getElementById(`short-${id}`);
            const fullView = document.getElementById(`full-${id}`);
            if (shortView.classList.contains('hidden')) {
                shortView.classList.remove('hidden');
                fullView.classList.add('hidden');
            } else {
                shortView.classList.add('hidden');
                fullView.classList.remove('hidden');
            }
        }

        // --- LIGHTBOX (NOW FORCED FULL SCREEN) ---
        function openLightbox(srcOrContent) {
            const lightbox = document.getElementById('lightbox');
            const wrapper = document.getElementById('lightbox-wrapper');
            wrapper.innerHTML = ""; 

            if(srcOrContent.includes('<div')) {
                // Handle complex DIV content (like the dark mode concept card)
                const div = document.createElement('div');
                div.innerHTML = srcOrContent;
                div.className = "w-full flex justify-center";
                wrapper.appendChild(div);
            } 
            else if (srcOrContent.startsWith('data:video') || srcOrContent.endsWith('.mp4')) {
                const video = document.createElement('video');
                video.src = srcOrContent;
                video.controls = true;
                video.autoplay = true;
                video.className = "max-w-[95%] max-h-[90vh] rounded-lg shadow-2xl bg-black";
                wrapper.appendChild(video);
            }
            else {
                const img = document.createElement('img');
                img.src = srcOrContent;
                img.className = "max-w-[95%] max-h-[95vh] rounded-lg shadow-2xl";
                wrapper.appendChild(img);
            }
            lightbox.classList.add('active');
        }

        function closeLightbox() {
            const lightbox = document.getElementById('lightbox');
            const wrapper = document.getElementById('lightbox-wrapper');
            const video = wrapper.querySelector('video');
            if(video) video.pause();
            lightbox.classList.remove('active');
        }

        // --- COMPOSE ---
        function insertCodeBlock() {
            const textarea = document.getElementById('compose-text');
            const cursorStart = textarea.selectionStart;
            const cursorEnd = textarea.selectionEnd;
            const text = textarea.value;
            const before = text.substring(0, cursorStart);
            const selection = text.substring(cursorStart, cursorEnd);
            const after = text.substring(cursorEnd);
            textarea.value = `${before}\n\`\`\`javascript\n${selection || '// Code here'}\n\`\`\`\n${after}`;
            textarea.focus();
        }

        function openCompose() {
            const overlay = document.getElementById('compose-overlay');
            overlay.classList.remove('modal-enter');
            overlay.classList.add('modal-active');
            document.getElementById('compose-text').focus();
        }

        function closeCompose() {
            const overlay = document.getElementById('compose-overlay');
            overlay.classList.remove('modal-active');
            overlay.classList.add('modal-enter');
        }
        document.getElementById('compose-overlay').addEventListener('click', function(e) { if (e.target === this) closeCompose(); });


        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentMedia = e.target.result;
                    currentMediaType = file.type.startsWith('video') ? 'video' : 'image';
                    const container = document.getElementById('media-preview-container');
                    const imgPreview = document.getElementById('media-preview-img');
                    const vidPreview = document.getElementById('media-preview-video');
                    if (currentMediaType === 'video') {
                        imgPreview.classList.add('hidden');
                        vidPreview.src = currentMedia;
                        vidPreview.classList.remove('hidden');
                    } else {
                        vidPreview.classList.add('hidden');
                        imgPreview.src = currentMedia;
                        imgPreview.classList.remove('hidden');
                    }
                    container.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeMedia() {
            currentMedia = null;
            currentMediaType = null;
            mediaVisionLog = "";
            document.getElementById('media-preview-container').classList.add('hidden');
            document.getElementById('media-input').value = "";
        }

        async function analyzeMedia(element) {
            let log = "";
            let imageToAnalyze = element;
            
            // For videos, grab a frame for analysis
            if (element.tagName === 'VIDEO') {
                const canvas = document.createElement('canvas');
                canvas.width = element.videoWidth || 640;
                canvas.height = element.videoHeight || 360;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(element, 0, 0, canvas.width, canvas.height);
                imageToAnalyze = document.createElement('img');
                imageToAnalyze.src = canvas.toDataURL();
            }

            if (classifier) {
                try {
                    const results = await classifier.predict(imageToAnalyze);
                    if (results && results.length > 0) {
                        const objects = results.map(r => r.label).join(", ");
                        log += `[Visual Objects: ${objects}] `;
                    }
                } catch (e) { console.log("ML5 Error", e); }
            }
            try {
                const { data: { text } } = await Tesseract.recognize(imageToAnalyze.src, 'eng');
                if (text && text.trim().length > 0) {
                     const cleanText = text.replace(/\n/g, ' ').substring(0, 150); 
                     log += `[OCR Text: "${cleanText}..."] `;
                }
            } catch (e) { console.log("OCR Error", e); }

            // Mocked audio/video transcription/summary for demo context
            if (element.tagName === 'VIDEO') {
                log += `[Mocked Audio/Dialogue: User speaks about project deadlines and team collaboration.]`;
            }

            return log;
        }

        // --- POST LOGIC ---
        async function publishPost() {
            const textRaw = document.getElementById('compose-text').value;
            const btn = document.getElementById('btn-publish');
            
            if (!textRaw.trim() && !currentMedia) { showToast("Cannot publish empty post!"); return; }

            // START LOADING
            const originalBtn = btn.innerHTML;
            btn.innerHTML = `<div class="scanning-loader"></div> Processing`;
            btn.disabled = true;

            // 0. MEDIA ANALYSIS
            mediaVisionLog = "";
            if (currentMedia) {
                document.getElementById('scan-indicator').classList.remove('hidden'); 
                const mediaEl = currentMediaType === 'video' ? document.getElementById('media-preview-video') : document.getElementById('media-preview-img');
                mediaVisionLog = await analyzeMedia(mediaEl);
            }

            // 1. SAFETY CHECK (MODERATION)
            const isSafe = await checkContentSafety(textRaw, mediaVisionLog);
            document.getElementById('scan-indicator').classList.add('hidden'); 

            if (!isSafe) {
                showToast("Post blocked: Detected prohibited content (AI video, slang, or unsafe media).", true);
                btn.innerHTML = originalBtn;
                btn.disabled = false;
                removeMedia(); // Clear media after block
                return;
            }

            // --- BUILD POST CONTENT ---
            let mediaHTML = "";
            let linkPreviewHTML = "";
            
            if (currentMedia) {
                if (currentMediaType === 'video') {
                    mediaHTML = `
                    <div class="mt-4 rounded-[20px] overflow-hidden border border-[#e0e2e5] shadow-sm cursor-pointer relative group">
                        <video src="${currentMedia}" class="w-full h-auto max-h-[400px]"></video>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none group-hover:bg-black/10 transition-colors" onclick="openLightbox('${currentMedia}')">
                            <div class="bg-black/50 p-3 rounded-full text-white"><i data-lucide="play" class="w-6 h-6 fill-white"></i></div>
                        </div>
                        <span class="hidden" data-ai-context>Video Analysis Log: ${mediaVisionLog}</span>
                    </div>`;
                } else {
                    mediaHTML = `
                    <div class="mt-4 rounded-[20px] overflow-hidden border border-[#e0e2e5] shadow-sm cursor-pointer" onclick="openLightbox('${currentMedia}')">
                        <img src="${currentMedia}" class="w-full h-auto object-cover max-h-[400px]" alt="User uploaded image">
                        <span class="hidden" data-ai-context>Image Analysis Log: ${mediaVisionLog}</span>
                    </div>`;
                }
            }

            // --- LINK DETECTION ---
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const urls = textRaw.match(urlRegex);
            
            // Remove URLs from display text
            let displayText = textRaw;
            if (urls) {
                const uniqueUrls = [...new Set(urls)];
                uniqueUrls.forEach(u => {
                    displayText = displayText.replace(u, ''); // Strip link from body
                });
                
                // Fetch metadata (Mocked in background for demo simplicity)
                const metaResults = await Promise.all(uniqueUrls.map(url => fetchLinkMetadata(url)));

                metaResults.forEach((meta, index) => {
                    const originalUrl = uniqueUrls[index];
                    let domain = "External Link";
                    try { domain = new URL(originalUrl).hostname.replace('www.', ''); } catch(e){}

                    let title = meta?.title || domain;
                    let desc = meta?.description || "Click to view content.";
                    let img = meta?.image?.url || "https://placehold.co/600x300/e0e2e5/1f1f1f?text=No+Image";

                    linkPreviewHTML += `
                    <a href="${originalUrl}" target="_blank" class="link-preview">
                        <div class="link-preview-image" style="background-image: url('${img}');"></div>
                        <div class="link-info">
                            <div class="link-domain">
                                ${meta?.logo?.url ? `<img src="${meta.logo.url}" class="w-4 h-4 rounded-sm object-contain">` : ''} 
                                ${domain}
                            </div>
                            <div class="link-title">${title}</div>
                            <div class="link-desc">${desc}</div>
                        </div>
                    </a>`;
                });
            }

            displayText = displayText.trim();

            let formattedText = displayText.replace(/#(\w+)/g, '<span class="hashtag" onclick="filterFeed(\'#$1\')">#$1</span>');
            
            const words = formattedText.split(/\s+/);
            let textHTML = "";
            
            if (displayText.length > 0) {
                if (words.length > 150) {
                    const shortText = words.slice(0, 150).join(" ") + "...";
                    const shortHTML = marked.parse(shortText);
                    const fullHTML = marked.parse(formattedText);
                    const uniqueId = 'post-' + Date.now();
                    const textId = 'text-' + uniqueId;

                    textHTML = `
                        <div id="short-${textId}">
                            <div class="text-[#1f1f1f] text-[16px] leading-7 mb-2">${shortHTML}</div>
                            <button onclick="toggleText('${textId}')" class="text-[#0b57d0] font-bold text-sm hover:underline mt-1">Show More</button>
                        </div>
                        <div id="full-${textId}" class="hidden">
                            <div class="text-[#1f1f1f] text-[16px] leading-7 mb-2">${fullHTML}</div>
                            <button onclick="toggleText('${textId}')" class="text-[#0b57d0] font-bold text-sm hover:underline mt-1">Show Less</button>
                        </div>
                    `;
                } else {
                    textHTML = `<div class="text-[#1f1f1f] text-[16px] leading-7 mb-2">${marked.parse(formattedText)}</div>`;
                }
            }

            const feed = document.getElementById('feed-container');
            const uniqueId = 'post-' + Date.now();
            const author = "Jane Doe";

            const newPostHTML = `
            <article class="post-card rounded-[24px] p-0 group overflow-hidden cursor-default fade-in mb-6" id="${uniqueId}">
                <div class="p-6"> 
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex gap-4">
                            <div class="h-11 w-11 bg-orange-600 text-white rounded-full flex items-center justify-center font-medium text-sm">JD</div>
                            <div>
                                <h3 class="font-bold text-[#1f1f1f] text-[16px] google-font">${author}</h3>
                                <span class="text-xs text-[#444746] font-medium">Engineering Core â€¢ Just now</span>
                            </div>
                        </div>
                        <button class="p-2 hover:bg-[#e0e2e5] rounded-full text-[#444746] opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button>
                    </div>
                    <div class="post-content mt-3">
                        ${textHTML}
                        ${mediaHTML}
                        ${linkPreviewHTML}
                    </div>
                </div>
                <div class="border-t border-[#f5f5f5] w-full"></div> 
                <div class="px-6 py-3 flex items-center justify-between opacity-80 group-hover:opacity-100 transition-opacity">
                    <div class="flex gap-2">
                        <button class="flex items-center gap-2 px-4 py-2.5 rounded-full hover:bg-[#ffebee] hover:text-[#d93025] text-[#444746] text-sm font-bold transition-colors"><i data-lucide="heart" class="w-5 h-5"></i> 0</button>
                        <button class="flex items-center gap-2 px-4 py-2.5 rounded-full hover:bg-[#e8f0fe] hover:text-[#0b57d0] text-[#444746] text-sm font-bold transition-colors"><i data-lucide="message-circle" class="w-5 h-5"></i> 0</button>
                        <button class="p-2.5 rounded-full hover:bg-[#e8f0fe] hover:text-[#0b57d0] text-[#444746] transition-colors" title="Share"><i data-lucide="share-2" class="w-5 h-5"></i></button>
                    </div>
                    <div class="flex gap-2 transform translate-y-2 group-hover:translate-y-0 opacity-0 group-hover:opacity-100 transition-all">
                        <button onclick="pinPost('${uniqueId}', '${author}')" class="flex items-center gap-2 px-4 py-2.5 rounded-full bg-[#e8f0fe] hover:bg-[#d3e3fd] text-[#0b57d0] text-xs font-bold transition-colors"><i data-lucide="sparkles" class="w-4 h-4 fill-[#0b57d0] stroke-none"></i> AI CONTEXT</button>
                        <button onclick="openNotebook('${uniqueId}', '${author}')" class="flex items-center gap-2 px-4 py-2.5 rounded-full bg-[#f0f4f9] hover:bg-[#e0e2e5] text-[#1f1f1f] text-xs font-bold transition-colors"><i data-lucide="notebook-pen" class="w-4 h-4"></i> NOTE</button>
                    </div>
                </div>
            </article>`;

            feed.insertAdjacentHTML('afterbegin', newPostHTML);
            document.getElementById('compose-text').value = "";
            removeMedia();
            btn.innerHTML = originalBtn;
            btn.disabled = false;
            closeCompose();
            showToast("Post Published!");
            lucide.createIcons();
        }

        // --- LINK METADATA MOCK ---
        async function fetchLinkMetadata(url) {
            try {
                // Mock API call since actual microlink API requires a key
                console.log(`Mocking metadata fetch for: ${url}`);
                await new Promise(r => setTimeout(r, 200)); 
                return {
                    title: "Internal Microservices Documentation",
                    description: "Documentation on the latest API Gateway changes for Q4 deployment.",
                    image: { url: "https://placehold.co/600x300/34d399/ffffff?text=Microservices+API" },
                    logo: { url: "https://placehold.co/40x40/0b57d0/ffffff?text=API" }
                };
            } catch (e) { console.log("Metadata Fetch Failed", e); }
            return null;
        }


        // --- NOTEBOOK ---
        function openNotebook(postId, authorName) {
            const sheet = document.getElementById('notebook-sheet');
            const backdrop = document.getElementById('notebook-backdrop');
            const sourceContainer = document.getElementById('notebook-source-content');
            const postElement = document.getElementById(postId);
            
            const contentDiv = postElement.querySelector('.post-content');
            let clone;
            const fullVer = contentDiv.querySelector(`[id^="full-text-"]`);
            if(fullVer) {
                clone = contentDiv.cloneNode(true);
                const shortDiv = clone.querySelector(`[id^="short-text-"]`);
                if(shortDiv) shortDiv.remove();
                const fullDiv = clone.querySelector(`[id^="full-text-"]`);
                fullDiv.classList.remove('hidden');
                fullDiv.querySelectorAll('button').forEach(b => b.remove());
            } else {
                clone = contentDiv.cloneNode(true);
            }

            const linkPreviews = clone.querySelectorAll('.link-preview');
            linkPreviews.forEach(lp => lp.remove());

            sourceContainer.innerHTML = `
                <div class="flex items-center gap-2 mb-3 pb-3 border-b border-[#f0f0f0]">
                    <span class="font-bold text-[#1f1f1f]">Post by ${authorName}</span>
                </div>
            `;
            sourceContainer.appendChild(clone);

            const vids = sourceContainer.querySelectorAll('video');
            vids.forEach(v => { 
                v.controls = true; 
                v.style.maxHeight = "200px"; 
                v.style.width = "100%";
                v.classList.remove('cursor-pointer'); 
                v.onclick = null;
            });

            document.getElementById('note-title').value = "";
            document.getElementById('note-body').value = "";
            sheet.classList.add('notebook-active');
            backdrop.classList.add('active');
        }

        function closeNotebook() {
            document.getElementById('notebook-sheet').classList.remove('notebook-active');
            document.getElementById('notebook-backdrop').classList.remove('active');
        }

        function saveNote() {
            const title = document.getElementById('note-title').value.trim();
            const body = document.getElementById('note-body').value.trim();
            if (!title && !body) { showToast("Note is empty!"); return; }
            showToast("Note Saved Successfully");
            setTimeout(() => { closeNotebook(); }, 800);
        }

        // --- AI LOGIC ---
        async function generateAiNotes() {
            const sourceContent = getSmartContent(document.getElementById('notebook-source-content'));
            const textarea = document.getElementById('note-body');
            const btn = document.getElementById('btn-use-ai');
            if (!sourceContent) { showToast("Reference content is empty!"); return; }

            const originalBtnContent = btn.innerHTML;
            btn.innerHTML = `<div class="w-4 h-4 border-2 border-[#0b57d0] border-t-transparent rounded-full animate-spin"></div> Thinking...`;
            btn.disabled = true;
            textarea.parentElement.classList.add('ai-processing');

            const prompt = `You are a sophisticated research assistant. Analyze the content below (including text and computer vision logs).
            Produce a high-quality Markdown note with the following sections:
            ### 1. Visual Scene Analysis
            (Synthesize the [Visual Data] logs, including object detection and OCR, into a natural description. If the log contains [Mocked Audio/Dialogue], also summarize the spoken content. If no visual/audio data, state "No visual/audio context provided.")
            ### 2. Core Context
            (Summarize the main textual message and technical details.)
            ### 3. Actionable Insights
            (Bullet points on what to do next or key takeaways.)
            Content to Analyze: ${sourceContent}`;

            try {
                const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}?model=openai`);
                const aiNotes = await response.text();
                if(textarea.value.trim() !== "") textarea.value += "\n\n" + aiNotes;
                else textarea.value = aiNotes;
                showToast("Smart Notes Generated");
            } catch (error) { showToast("AI Error. Try again."); } 
            finally {
                btn.innerHTML = originalBtnContent;
                btn.disabled = false;
                textarea.parentElement.classList.remove('ai-processing');
            }
        }

        async function fixSpelling() {
            const textarea = document.getElementById('note-body');
            const btn = document.getElementById('btn-fix-spelling');
            const originalText = textarea.value.trim();
            if (!originalText) { showToast("Type something first!"); return; }
            
            const originalBtnContent = btn.innerHTML;
            btn.innerHTML = `<div class="w-4 h-4 border-2 border-[#0b57d0] border-t-transparent rounded-full animate-spin"></div> Fixing...`;
            btn.disabled = true;
            textarea.parentElement.classList.add('ai-processing');

            try {
                const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent("Correct spelling/grammar: " + originalText)}?model=openai`);
                textarea.value = await response.text();
                showToast("Spelling Fixed");
            } catch (error) { showToast("AI Error."); } 
            finally {
                btn.innerHTML = originalBtnContent;
                btn.disabled = false;
                textarea.parentElement.classList.remove('ai-processing');
            }
        }

        // --- SIDEBAR & CONTEXT LOGIC ---
        function switchMode(mode) {
            const btnAi = document.getElementById('btn-mode-ai');
            const btnTrend = document.getElementById('btn-mode-trend');
            const viewAi = document.getElementById('view-ai');
            const viewTrend = document.getElementById('view-trend');
            const active = ['bg-white', 'text-[#001d35]', 'shadow-sm'];
            const inactive = ['text-[#444746]', 'hover:text-[#1f1f1f]', 'bg-transparent', 'shadow-none'];

            btnAi.className = "flex-1 py-3 rounded-full text-sm font-bold flex items-center justify-center gap-2 transition-all duration-300";
            btnTrend.className = "flex-1 py-3 rounded-full text-sm font-bold flex items-center justify-center gap-2 transition-all duration-300";

            if (mode === 'ai') {
                btnAi.classList.add(...active); btnTrend.classList.add(...inactive);
                viewAi.classList.remove('hidden'); viewTrend.classList.add('hidden');
            } else {
                btnTrend.classList.add(...active); btnAi.classList.add(...inactive);
                viewTrend.classList.remove('hidden'); viewAi.classList.add('hidden');
            }
        }

        function getSmartContent(postElementOrClone) {
            const contentDiv = postElementOrClone.querySelector ? postElementOrClone.querySelector('.post-content') : postElementOrClone;
            const target = contentDiv || postElementOrClone;
            
            const fullTextDiv = target.querySelector('[id^="full-"]');
            let clone;
            if (fullTextDiv) {
                clone = fullTextDiv.cloneNode(true);
                const containerClone = target.cloneNode(true);
                const short = containerClone.querySelector('[id^="short-"]');
                if(short) short.remove();
                clone = containerClone;
            } else {
                clone = target.cloneNode(true);
            }
            
            clone.querySelectorAll('[data-ai-context]').forEach(hint => {
                const marker = document.createElement('span');
                marker.innerText = ` \n[Visual Data]: ${hint.innerText}\n `;
                hint.replaceWith(marker);
            });

            clone.querySelectorAll('img').forEach(img => img.remove());
            clone.querySelectorAll('video').forEach(v => v.remove());
            clone.querySelectorAll('button').forEach(b => b.remove());
            
            return clone.innerText.replace(/\s+/g, ' ').trim();
        }

        function pinPost(postId, authorName) {
            switchMode('ai');
            const postElement = document.getElementById(postId);
            const richContent = getSmartContent(postElement);
            currentContext = `System Prompt: You are a helpful assistant with vision capabilities. Context: User is viewing a post by ${authorName}. Post Data: ${richContent}. Instructions: Describe media if present in logs. Answer questions concisely.`;
            document.getElementById('ai-context-chip').classList.remove('hidden');
            document.getElementById('ai-context-text').innerText = `Post by ${authorName}`;
            addMessage(`I'm referencing ${authorName}'s post. I can see the content. Ask me anything!`, false);
            document.getElementById('ai-input').focus();
        }

        function clearContext() { currentContext = ""; document.getElementById('ai-context-chip').classList.add('hidden'); }

        const chatHistory = document.getElementById('chat-history');
        const aiInput = document.getElementById('ai-input');
        const sendBtn = document.getElementById('ai-send-btn');

        function addMessage(text, isUser = false) {
            const wrapper = document.createElement('div');
            if (isUser) {
                wrapper.className = 'flex justify-end mb-4';
                wrapper.innerHTML = `<div class="bg-[#0b57d0] text-white px-5 py-3 rounded-[20px] rounded-br-none text-[15px] max-w-[85%] shadow-sm leading-relaxed">${text}</div>`;
            } else {
                wrapper.className = 'flex flex-col gap-2 mb-4 fade-in';
                const content = marked.parse(text);
                wrapper.innerHTML = `<div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-[#f0f4f9] flex items-center justify-center"><i data-lucide="sparkles" class="w-3 h-3 text-[#0b57d0]"></i></div><span class="text-xs font-bold text-[#444746]">Newton</span></div><div class="text-[15px] text-[#1f1f1f] leading-relaxed bg-[#f0f4f9] p-4 rounded-[20px] rounded-tl-none max-w-[90%]">${content}</div>`;
            }
            chatHistory.appendChild(wrapper);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            lucide.createIcons();
        }

        async function handleSend() {
            const text = aiInput.value.trim();
            if (!text) return;
            addMessage(text, true);
            aiInput.value = '';
            const finalQuery = currentContext ? `${currentContext}\n\nUser: ${text}` : text;
            const loading = document.createElement('div');
            loading.id = 'ai-loading';
            loading.className = 'flex gap-2 items-center text-sm text-[#444746] animate-pulse mb-4 pl-2';
            loading.innerHTML = '<div class="w-2 h-2 bg-[#0b57d0] rounded-full"></div> Thinking...';
            chatHistory.appendChild(loading);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            try {
                const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(finalQuery)}?model=openai`);
                const aiText = await response.text();
                if(document.getElementById('ai-loading')) document.getElementById('ai-loading').remove();
                addMessage(aiText, false);
            } catch (error) {
                if(document.getElementById('ai-loading')) document.getElementById('ai-loading').remove();
                addMessage("Connection error.", false);
            }
        }

        sendBtn.addEventListener('click', handleSend);
        aiInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });
    </script>
</body>
</html>
